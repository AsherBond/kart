---
name: Build

on: [push, pull_request]

env:
  PIP_CACHE_DIR: ${{ github.workspace }}/.cache/pip

jobs:
  #
  # Linux Builds
  #
  Linux:
    runs-on: ubuntu-20.04

    # We want to run on external PRs, but not on our own internal PRs as they'll be run
    # by the push to the branch.
    # https://github.community/t/duplicate-checks-on-push-and-pull-request-simultaneous-event/18012/7
    # Skip Linux builds with eg: `[ci only windows]` unless it's master or a release tag.
    if: >
      (
        github.event_name == 'push'
        || github.event.pull_request.head.repo.full_name != github.repository
      ) && (
        startsWith(github.ref, 'refs/tags/v')
        || github.ref == 'refs/heads/master'
        || !contains(github.event.head_commit.message, '[ci only windows]')
        || !contains(github.event.head_commit.message, '[ci only macos]')
      )

    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_COMPRESS: "1"
      PY_VER: "3.7"
      HOMEBREW_CACHE: ${{ github.workspace }}/.cache/brew
      HOMEBREW_NO_INSTALL_CLEANUP: "1"
    services:
      postgis:
        image: postgis/postgis
        options: >-
          --health-cmd pg_isready
          --health-interval 2s
          --health-timeout 2s
          --health-retries 5
          -e POSTGRES_HOST_AUTH_METHOD=trust
        ports:
          - 5432:5432
      sqlserver:
        image: mcr.microsoft.com/mssql/server
        options: >-
          -e ACCEPT_EULA=Y
          -e SA_PASSWORD=PassWord1
        ports:
          - 1433:1433
      mysql:
        image: mysql
        options: >-
          -e MYSQL_ROOT_PASSWORD=PassWord1
        ports:
          - 3306:3306

    steps:
      - uses: actions/checkout@v2

      #
      # python distribution
      #

      - name: "python: pip cache"
        uses: actions/cache@v1
        with:
          path: .cache/pip
          key: pip-Linux-${{ hashFiles('requirements.txt') }}-${{ hashFiles('requirements/*.txt') }}-${{ hashFiles('Makefile') }}
          restore-keys: |
            pip-Linux-

      - name: "python"
        uses: actions/setup-python@v1
        with:
          python-version: ${{ env.PY_VER }}

      #
      # vendor build
      #

      # get last time's vendor bundle
      # a hit here leads to skipping the rest of this phase

      - name: "vendor: dist cache"
        id: cache-vendor-dist
        uses: actions/cache@v1
        with:
          path: vendor/dist/
          key: vendor-dist-Linux-${{ env.PY_VER }}-${{ hashFiles('vendor/**/Makefile') }}-${{ hashFiles('vendor/Makefile') }}-${{ hashFiles('vendor/build-manylinux.sh') }}

      - name: "vendor: source cache"
        id: cache-vendor-source
        uses: actions/cache@v1
        if: steps.cache-vendor-dist.outputs.cache-hit != 'true'
        with:
          path: .cache/vendor-source
          key: vendor-source-Linux-${{ env.PY_VER }}-${{ hashFiles('vendor/**/Makefile') }}-${{ hashFiles('vendor/Makefile') }}

      - name: "vendor: source download"
        if: "steps.cache-vendor-dist.outputs.cache-hit != 'true' && steps.cache-vendor-source.outputs.cache-hit != 'true'"
        run: |
          tar xvf .cache/vendor-source/vendor.tar || true
          echo 'verbose = off' >> $HOME/.wgetrc
          make -C vendor sources
          mkdir -p .cache/vendor-source
          tar cvf .cache/vendor-source/vendor.tar vendor/*/*.tar.* vendor/*/*.zip

      - name: "vendor: ccache"
        uses: actions/cache@v1
        if: steps.cache-vendor-dist.outputs.cache-hit != 'true'
        with:
          path: .ccache
          key: vendor-ccache-Linux

      - name: "vendor: build"
        if: steps.cache-vendor-dist.outputs.cache-hit != 'true'
        run: |
          tar xvf .cache/vendor-source/vendor.tar
          echo 'verbose = off' >> $HOME/.wgetrc
          make -C vendor build-Linux

      - name: "vendor: save library bundle"
        uses: actions/upload-artifact@v2
        with:
          name: vendor-Linux
          path: vendor/dist/vendor-Linux.tar.gz

      #
      # App Build
      #

      - name: "app: version"
        id: version
        run: |
          if [[ '${{ github.repository }}' != 'koordinates/kart' ]]; then
            IS_FORK=1  # some other repo
          elif [[ -n '${{ github.event.pull_request.id }}' ]] && [[ '${{ github.event.pull_request.head.repo.full_name }}' != '${{ github.repository }}' ]]; then
            IS_FORK=1  # pr not on main repo
          else
            IS_FORK=0
          fi
          if (( ! $IS_FORK )) && [[ '${{ github.ref }}' =~ ^refs/tags/v(.*) ]]; then
            VER="${BASH_REMATCH[1]}"
            IS_RELEASE=1
          else
            VER=$(sed -E "s/(.*)/\1+ci.${{ github.run_number }}.git${GITHUB_SHA::8}/" kart/VERSION)
            IS_RELEASE=0
          fi
          echo "App Version: $VER"
          echo "Is Release? $IS_RELEASE"
          echo "Is Fork PR? $IS_FORK"
          echo "$VER" > kart/VERSION
          echo "::set-output name=value::$VER"
          echo "::set-output name=is_release::$IS_RELEASE"
          echo "::set-output name=is_fork::$IS_FORK"

      - name: "app: install python dependencies"
        run: |
          make py-deps

      - name: "app: build"
        run: |
          make release
          venv/bin/kart --version

      #
      # App tests & checks
      #

      - name: "app: install test dependencies"
        run: |
          make py-deps-dev

      - name: "app: install database drivers for tests"
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list > /dev/null
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17

      - name: "app: license check"
        run: |
          make py-license-check

      - name: "app: unit tests"
        run: |
          make ci-test

      - name: "app: save test coverage"
        uses: actions/upload-artifact@v2
        with:
          name: test-results-Linux
          path: test-results/

      #
      # Packaging
      #
      - name: "package: assemble"
        id: package-Linux
        run: |
          make -C platforms deb rpm
          ls -la platforms/linux/dist/*.rpm platforms/linux/dist/*.deb

      # Pre-cache cleanup

      - name: "package: cleanup"
        run: |
          sudo find vendor/dist -mindepth 1 -maxdepth 1 ! -name "vendor-Linux.tar.gz" -exec rm -rf {} \;

      #
      # Uploading packages
      #

      - name: "package: save deb"
        uses: actions/upload-artifact@v2
        with:
          name: Linux-deb
          path: platforms/linux/dist/*.deb

      - name: "package: save rpm"
        uses: actions/upload-artifact@v2
        with:
          name: Linux-rpm
          path: platforms/linux/dist/*.rpm

      - name: "package: save packaging logs"
        uses: actions/upload-artifact@v2
        with:
          name: packaging-logs-Linux
          path: |
            platforms/*/build/kart/*.toc
            platforms/*/build/kart/*.txt
            platforms/*/build/kart/*.html

      #
      # Package tests
      #

      - name: "package: tests"
        run: |
          make -C platforms test-deb-all test-rpm-all

      #
      # Github release
      #

      - name: release
        uses: softprops/action-gh-release@v1
        if: "steps.version.outputs.is_release == 1"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          draft: true
          files: |
            platforms/linux/dist/*.deb
            platforms/linux/dist/*.rpm

  #
  # Windows Builds
  #
  windows:
    name: Windows
    runs-on: windows-2016
    # We want to run on external PRs, but not on our own internal PRs as they'll be run
    # by the push to the branch.
    # https://github.community/t/duplicate-checks-on-push-and-pull-request-simultaneous-event/18012/7
    # Skip Windows builds with eg: `[ci only linux]` unless it's master or a release tag.
    if: >
      (
        github.event_name == 'push'
        || github.event.pull_request.head.repo.full_name != github.repository
      ) && (
        startsWith(github.ref, 'refs/tags/v')
        || github.ref == 'refs/heads/master'
        || !contains(github.event.head_commit.message, '[ci only linux]')
        || !contains(github.event.head_commit.message, '[ci only macos]')
      )
    steps:
      - name: "msvc setup"
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          toolset: 14.0

      - uses: actions/checkout@v2

      #
      # python distribution
      #

      - name: "python"
        run: |
          $PY3=(Get-Command python).Definition
          echo "PY3=$PY3" >> $Env:GITHUB_ENV

      - name: "python: pip cache"
        uses: actions/cache@v1
        with:
          path: .cache/pip
          key: pip-windows-${{ hashFiles('requirements.txt') }}-${{ hashFiles('requirements/*.txt') }}-${{ hashFiles('makefile.vc') }}
          restore-keys: |
            pip-windows-

      #
      # vendor build
      #

      # get last time's vendor bundle
      # a hit here leads to skipping the rest of this job

      - name: "vendor-dist: cache"
        id: cache-dist
        uses: actions/cache@v1
        with:
          path: vendor/dist/
          key: vendor-dist-Windows-${{ hashFiles('vendor/makefile.vc') }}

      - name: "vendor: build"
        if: steps.cache-dist.outputs.cache-hit != 'true'
        working-directory: vendor
        env:
          PWSH: pwsh.exe
        run: |
          nmake /D /NoLogo /F makefile.vc

      - name: "vendor: save library bundle"
        uses: actions/upload-artifact@v2
        with:
          name: vendor-Windows
          path: vendor/dist/vendor-Windows.zip

      #
      # App Build
      #

      - name: "app: version"
        id: version
        run: |
          $IS_FORK = ( ('${{ github.repository }}' -ne 'koordinates/kart') -or ( '${{ github.event.pull_request.id }}' -and ( '${{ github.event.pull_request.head.repo.full_name }}' -ne '${{ github.repository }}') ) ) ? 1 : 0

          If ( (-not $IS_FORK) -and ('${{ github.ref }}'.StartsWith('refs/tags/v')) ) {
            $VER='${{ github.ref }}'.Substring(11)
            $IS_RELEASE=1
          } Else {
            $VER="$(Get-Content .\kart\VERSION)+ci.$($Env:GITHUB_SHA.Substring(0,8))"
            $IS_RELEASE=0
          }
          $VER -match '\d+\.\d+(\.\d+)?'
          $IVER=$Matches.0

          echo "App Version: $VER"
          echo "Installer Version: $IVER"
          echo "Is Release? $IS_RELEASE"
          echo "Is Fork PR? $IS_FORK"
          echo "$VER" > .\kart\VERSION
          echo "::set-output name=value::$VER"
          echo "::set-output name=installer::$IVER"
          echo "::set-output name=is_release::$IS_RELEASE"
          echo "::set-output name=is_fork::$IS_FORK"

      - name: "app: install python dependencies"
        run: |
          nmake /D /NoLogo /F makefile.vc venv\.requirements.installed

      - name: "app: build"
        run: |
          nmake /D /NoLogo /F makefile.vc
          venv\Scripts\kart.exe --version

      #
      # App tests & checks
      #

      - name: "app: install test dependencies"
        run: |
          nmake /D /NoLogo /F makefile.vc venv\.test.installed

      - name: "app: unit tests"
        run: |
          nmake /D /NoLogo /F makefile.vc ci-test

      - name: "app: save test coverage"
        uses: actions/upload-artifact@v2
        with:
          name: test-results-Windows
          path: test-results/

      #
      # Packaging
      #

      - name: "package: assemble"
        id: package
        env:
          KART_VERSION: ${{ steps.version.outputs.value }}
          KART_INSTALLER_VERSION: ${{ steps.version.outputs.installer }}
          WIN_SIGN_AZURE_CERTIFICATE: ${{ secrets.WIN_SIGN_AZURE_CERTIFICATE }}
          SIGN_AZURE_VAULT: ${{ secrets.WIN_SIGN_AZURE_VAULT }}
          SIGN_AZURE_CLIENTID: ${{ secrets.WIN_SIGN_AZURE_CLIENTID }}
          SIGN_AZURE_CLIENTSECRET: ${{ secrets.WIN_SIGN_AZURE_CLIENTSECRET }}
        run: |
          If ( ${{ steps.version.outputs.is_release }} -eq 1 ) {
            dotnet tool install --global AzureSignTool --version 2.0.17

            $Env:SIGN_AZURE_CERTIFICATE=$Env:WIN_SIGN_AZURE_CERTIFICATE
          }

          nmake /D /NoLogo /F makefile.vc package
          echo "::set-output name=msi::platforms\windows\dist\Kart-${{ steps.version.outputs.value }}.msi"

      #
      # Uploading package
      #

      - name: "package: save msi"
        uses: actions/upload-artifact@v2
        with:
          name: Windows-msi
          path: ${{ steps.package.outputs.msi }}

      - name: "package: save packaging logs"
        uses: actions/upload-artifact@v2
        with:
          name: packaging-logs-Windows
          path: |
            platforms/windows/build/kart/*.toc
            platforms/windows/build/kart/*.txt
            platforms/windows/build/kart/*.html

      #
      # Package tests
      #

      - name: "package: tests"
        run: |
          Start-Process msiexec.exe -Wait -ArgumentList '/I ${{github.workspace}}\${{ steps.package.outputs.msi }} /quiet /norestart /l* install.log'
          if (Test-Path install.log -PathType leaf) { Get-Content install.log }
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" +[System.Environment]::GetEnvironmentVariable("Path", "User")
          & kart --version
          & tests\scripts\distcheck.ps1
          & tests\scripts\e2e-1.ps1

      #
      # Github release
      #

      - name: release
        uses: softprops/action-gh-release@v1
        if: "steps.version.outputs.is_release == 1"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          draft: true
          files: |
            ${{ steps.package.outputs.msi }}

  #
  # macOS Builds
  #
  macOS:
    runs-on: macos-latest

    # We want to run on external PRs, but not on our own internal PRs as they'll be run
    # by the push to the branch.
    # https://github.community/t/duplicate-checks-on-push-and-pull-request-simultaneous-event/18012/7
    # Skip macOS builds with eg: `[ci only linux]` unless it's master or a release tag.
    if: >
      (
        github.event_name == 'push'
        || github.event.pull_request.head.repo.full_name != github.repository
      ) && (
        startsWith(github.ref, 'refs/tags/v')
        || github.ref == 'refs/heads/master'
        || !contains(github.event.head_commit.message, '[ci only linux]')
        || !contains(github.event.head_commit.message, '[ci only windows]')
      )

    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_COMPRESS: "1"
      PY_VER: "3.7"
      PY3_PKG: python-3.7.6-macosx10.9.pkg
      PY3_URL: https://www.python.org/ftp/python/3.7.6/python-3.7.6-macosx10.9.pkg
      HOMEBREW_CACHE: ${{ github.workspace }}/.cache/brew
      HOMEBREW_NO_INSTALL_CLEANUP: "1"
    steps:
      - uses: actions/checkout@v2

      #
      # python distribution
      #

      - name: "python: cache"
        id: cache-pydist
        uses: actions/cache@v1
        with:
          path: .cache/pydist
          key: pydist-Darwin-${{ env.PY3_PKG }}

      - name: "python: download"
        if: steps.cache-pydist.outputs.cache-hit != 'true'
        run: |
          mkdir -p .cache/pydist
          wget -nv ${{ env.PY3_URL }} -O .cache/pydist/${{ env.PY3_PKG }}

      - name: "python: pip cache"
        uses: actions/cache@v1
        with:
          path: .cache/pip
          key: pip-macOS-${{ hashFiles('requirements.txt') }}-${{ hashFiles('requirements/*.txt') }}-${{ hashFiles('Makefile') }}
          restore-keys: |
            pip-macOS-

      #
      # vendor build
      #

      - name: "homebrew cache"
        id: cache-brew
        uses: actions/cache@v1
        with:
          path: .cache/brew
          key: brew

      - name: "prerequisites"
        run: |
          brew uninstall --force php composer
          brew update-reset
          sudo installer -pkg .cache/pydist/${{ env.PY3_PKG }} -dumplog -target /
          brew upgrade python@3.9 || echo "The link step of `brew upgrade python@3.9` fails. This is okay."
          brew install --force ccache pkg-config sqlite3 pandoc
          brew install --force --cask Packages
          brew bundle install --file=vendor/Brewfile
          echo "Currently installed vendor dependencies:"
          cat vendor/Brewfile | xargs brew list --versions --formulae | sort | tee vendor/Brewfile.lock

      # get last time's vendor bundle
      # a hit here leads to skipping the rest of this phase

      - name: "vendor: dist cache"
        id: cache-vendor-dist
        uses: actions/cache@v1
        with:
          path: vendor/dist/
          key: vendor-dist-Darwin-${{ env.PY_VER }}-${{ hashfiles('vendor/Brewfile.lock') }}-${{ hashFiles('vendor/**/Makefile') }}-${{ hashFiles('vendor/Makefile') }}

      - name: "vendor: source cache"
        id: cache-vendor-source
        uses: actions/cache@v1
        if: steps.cache-vendor-dist.outputs.cache-hit != 'true'
        with:
          path: .cache/vendor-source
          key: vendor-source-Darwin-${{ env.PY_VER }}-${{ hashFiles('vendor/**/Makefile') }}-${{ hashFiles('vendor/Makefile') }}

      - name: "vendor: source download"
        if: "steps.cache-vendor-dist.outputs.cache-hit != 'true' && steps.cache-vendor-source.outputs.cache-hit != 'true'"
        run: |
          tar xvf .cache/vendor-source/vendor.tar || true
          echo 'verbose = off' >> $HOME/.wgetrc
          make -C vendor sources
          mkdir -p .cache/vendor-source
          tar cvf .cache/vendor-source/vendor.tar vendor/*/*.tar.* vendor/*/*.zip

      - name: "vendor: ccache"
        uses: actions/cache@v1
        if: steps.cache-vendor-dist.outputs.cache-hit != 'true'
        with:
          path: .ccache
          key: vendor-ccache-Darwin

      - name: "vendor: build"
        if: steps.cache-vendor-dist.outputs.cache-hit != 'true'
        run: |
          tar xvf .cache/vendor-source/vendor.tar
          echo 'verbose = off' >> $HOME/.wgetrc
          make -C vendor build-Darwin

      - name: "vendor: save library bundle"
        uses: actions/upload-artifact@v2
        with:
          name: vendor-Darwin
          path: vendor/dist/vendor-Darwin.tar.gz

      #
      # App Build
      #

      - name: "app: version"
        id: version
        run: |
          if [[ '${{ github.repository }}' != 'koordinates/kart' ]]; then
            IS_FORK=1  # some other repo
          elif [[ -n '${{ github.event.pull_request.id }}' ]] && [[ '${{ github.event.pull_request.head.repo.full_name }}' != '${{ github.repository }}' ]]; then
            IS_FORK=1  # pr not on main repo
          else
            IS_FORK=0
          fi
          if (( ! $IS_FORK )) && [[ '${{ github.ref }}' =~ ^refs/tags/v(.*) ]]; then
            VER="${BASH_REMATCH[1]}"
            IS_RELEASE=1
          else
            VER=$(sed -E "s/(.*)/\1+ci.${{ github.run_number }}.git${GITHUB_SHA::8}/" kart/VERSION)
            IS_RELEASE=0
          fi
          echo "App Version: $VER"
          echo "Is Release? $IS_RELEASE"
          echo "Is Fork PR? $IS_FORK"
          echo "$VER" > kart/VERSION
          echo "::set-output name=value::$VER"
          echo "::set-output name=is_release::$IS_RELEASE"
          echo "::set-output name=is_fork::$IS_FORK"

      - name: "app: install python dependencies"
        run: |
          make py-deps

      - name: "app: build"
        run: |
          make release
          venv/bin/kart --version

      #
      # App tests & checks
      #

      - name: "app: install test dependencies"
        run: |
          make py-deps-dev

      - name: "app: license check"
        run: |
          make py-license-check

      - name: "app: unit tests"
        run: |
          make ci-test

      - name: "app: save test coverage"
        uses: actions/upload-artifact@v2
        with:
          name: test-results-macOS
          path: test-results/

      #
      # Packaging
      #
      - name: "package: setup app signing certificate"
        id: keychain
        uses: apple-actions/import-codesign-certs@v1
        if: "steps.version.outputs.is_fork == 0"
        with:
          p12-file-base64: ${{ secrets.MACOS_APP_CERT }}
          p12-password: ${{ secrets.MACOS_CERT_PW }}

      - name: "package: setup installer signing certificate"
        uses: apple-actions/import-codesign-certs@v1
        if: "steps.version.outputs.is_release == 1"
        with:
          create-keychain: false
          keychain-password: ${{ steps.keychain.outputs.keychain-password }}
          p12-file-base64: ${{ secrets.MACOS_INSTALLER_CERT }}
          p12-password: ${{ secrets.MACOS_CERT_PW }}

      - name: "package: assemble"
        id: package-Darwin
        env:
          NOTARIZE_USER: ${{ secrets.MACOS_NOTARIZE_USER }}
          NOTARIZE_PW: ${{ secrets.MACOS_NOTARIZE_PW }}
          NOTARIZE_PASSWORD: "@env:NOTARIZE_PW"
        run: |
          make py-tools

          if (( ! ${{ steps.version.outputs.is_fork }} )); then
            export CODESIGN="${{ secrets.MACOS_CODESIGN_ID }}"
          fi

          if (( ${{ steps.version.outputs.is_release }} )); then
            export PKGSIGN="${{ secrets.MACOS_PKGSIGN_ID }}"
            make -C platforms ci-pkg-notarize
          else
            make -C platforms pkg
          fi
          ls -la platforms/macos/dist/Kart-${{ steps.version.outputs.value }}.pkg
          echo "::set-output name=file::platforms/macos/dist/Kart-${{ steps.version.outputs.value }}.pkg"

      # Pre-cache cleanup

      - name: "package: cleanup"
        run: |
          sudo find vendor/dist -mindepth 1 -maxdepth 1 ! -name "vendor-Darwin.tar.gz" -exec rm -rf {} \;

      #
      # Uploading packages
      #

      - name: "package: save pkg"
        uses: actions/upload-artifact@v2
        with:
          name: macos-pkg
          path: ${{ steps.package-Darwin.outputs.file }}

      - name: "package: save packaging logs"
        uses: actions/upload-artifact@v2
        with:
          name: packaging-logs-macOS
          path: |
            platforms/*/build/kart/*.toc
            platforms/*/build/kart/*.txt
            platforms/*/build/kart/*.html

      #
      # Package tests
      #

      - name: "package: tests"
        run: |
          sudo installer -pkg ${{ steps.package-Darwin.outputs.file }} -dumplog -target /
          readlink $(which kart)
          tests/scripts/distcheck.sh
          PATH=/usr/local/opt/sqlite3/bin:$PATH tests/scripts/e2e-1.sh

      #
      # Github release
      #

      - name: release
        uses: softprops/action-gh-release@v1
        if: "steps.version.outputs.is_release == 1"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          draft: true
          files: |
            platforms/macos/dist/Kart-*.pkg
